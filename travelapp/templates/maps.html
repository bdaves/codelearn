<!DOCTYPE html>
<html>
  <head>
    <style>
       #map {
        height: 400px;
        width: 100%;
       }
    </style>
  </head>
  <body>
    <h3>My Google Maps Demo</h3>
    <div id="map"></div>
    <script>
      function initMap() {
        var location_data = {{location_data | safe}};

        var location_arr = [];
        var name_arr = [];
        var average_latitude = 0;
        var average_longitude = 0;
        var latitude, longitude, name;
        for (var idx = 0; idx < location_data.length; idx++) {
            latitude = location_data[idx]["latitude"];
            longitude = location_data[idx]["longitude"];
            name = location_data[idx]["title"];
            location_arr.push(new google.maps.LatLng(latitude, longitude));
            name_arr.push(name);
            average_longitude += longitude;
            average_latitude += latitude;
        }
        average_latitude /= idx;
        average_longitude /= idx;

        var middle = {lat: average_latitude, lng: average_longitude};
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 6,
          center: middle
        });
        var directionsService = new google.maps.DirectionsService;
        var directionsDisplay = new google.maps.DirectionsRenderer({
          map: map
        });
        
        // var marker = new google.maps.Marker({
        //   position: uluru,
        //   map: map
        // });


        // for (var idx = 0; idx < location_data.length; idx++) {
        //     new google.maps.Marker({
        //         position: location_arr[idx],
        //         title: name_arr[idx],
        //         map: map
        //     });
        // }

        var waypoints = [];
        if (location_arr.length > 2) {
            for (var idx=1; idx < location_arr.length-1; idx++) {
                waypoints.push({
                    location: location_arr[idx],
                    stopover: true
                });
            }
        }

        calculateAndDisplayRoute(directionsService, directionsDisplay, location_arr[0], location_arr[location_arr.length-1], 
          waypoints
          );
      }

      function calculateAndDisplayRoute(directionsService, directionsDisplay, pointA, pointB, waypoints) {
        directionsService.route({
          origin: pointA,
          destination: pointB,
          waypoints: waypoints,
          travelMode: google.maps.TravelMode.DRIVING 
        }, function(response, status) {
          if (status == google.maps.DirectionsStatus.OK) {
            directionsDisplay.setDirections(response);
          } else {
            window.alert('Directions request failed due to ' + status);
          }
        });
      }
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{APIKEY}}&callback=initMap">
    </script>
  </body>
  <a href="/newLocation">Add location!</a>
  <a href="/newUser">Add User!</a>
</html>